{% extends "base.html" %}

{% block title %}Entrada de Material - Almoxarifado{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-12">
            <h2><i class="bi bi-arrow-down-circle text-success"></i> Entrada de Material</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('listar_movimentacoes') }}">Movimentações</a></li>
                    <li class="breadcrumb-item active">Entrada</li>
                </ol>
            </nav>
        </div>
    </div>
    
    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Registrar Entrada</h5>
                </div>
                <div class="card-body">
                    <form method="POST" id="formEntrada">
                        <div class="mb-3">
                            <label for="busca_item" class="form-label">Buscar Item por Código de Barras, Nome ou Lote</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="busca_item" 
                                       placeholder="Digite para buscar..." autocomplete="off">
                                <button type="button" class="btn btn-outline-secondary" onclick="buscarItem()">
                                    <i class="bi bi-search"></i> Buscar
                                </button>
                            </div>
                            <div id="resultados_busca" class="list-group mt-2" style="display: none;"></div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="item_id" class="form-label">Item Selecionado *</label>
                            <select class="form-select" id="item_id" name="item_id" required onchange="carregarInfoItem()">
                                <option value="">Selecione um item...</option>
                                {% for item in itens %}
                                <option value="{{ item.id }}" 
                                        data-estoque="{{ item.estoque_atual }}" 
                                        data-unidade="{{ item.unidade_medida }}"
                                        data-codigo="{{ item.codigo_barras_barras }}"
                                        data-lote="{{ item.lote }}">
                                    {{ item.codigo_barras_barras }} - {{ item.nome }} (Lote: {{ item.lote }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="quantidade" class="form-label">Quantidade *</label>
                                <input type="number" step="0.01" class="form-control" id="quantidade" 
                                       name="quantidade" min="0.01" required>
                                <small class="form-text text-muted" id="unidadeMedida"></small>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="nota_fiscal" class="form-label">Nota Fiscal</label>
                                <input type="text" class="form-control" id="nota_fiscal" name="nota_fiscal">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="observacao" class="form-label">Observação</label>
                            <textarea class="form-control" id="observacao" name="observacao" rows="3"></textarea>
                        </div>
                        
                        <div class="alert alert-info" id="infoEstoque" style="display: none;">
                            <strong>Estoque Atual:</strong> <span id="estoqueAtual">-</span>
                            <br>
                            <strong>Novo Estoque:</strong> <span id="novoEstoque">-</span>
                        </div>
                        
                        <hr>
                        
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('listar_movimentacoes') }}" class="btn btn-secondary">
                                <i class="bi bi-arrow-left"></i> Voltar
                            </a>
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-check-circle"></i> Registrar Entrada
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="bi bi-info-circle"></i> Instruções</h6>
                </div>
                <div class="card-body">
                    <ol class="small">
                        <li>Selecione o item que está sendo recebido</li>
                        <li>Informe a quantidade recebida</li>
                        <li>Se disponível, informe o número da nota fiscal</li>
                        <li>Adicione observações se necessário</li>
                        <li>Confirme a entrada</li>
                    </ol>
                    
                    <hr>
                    
                    <p class="small text-muted mb-0">
                        <i class="bi bi-lightbulb"></i> 
                        O estoque será automaticamente atualizado após o registro.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Busca de itens
function buscarItem() {
    const termo = document.getElementById('busca_item').value.trim();
    const resultados = document.getElementById('resultados_busca');
    const select = document.getElementById('item_id');
    
    if (!termo) {
        resultados.style.display = 'none';
        return;
    }
    
    // Filtrar opções do select
    let encontrados = [];
    for (let option of select.options) {
        if (option.value && (
            option.dataset.codigo?.toLowerCase().includes(termo.toLowerCase()) ||
            option.dataset.lote?.toLowerCase().includes(termo.toLowerCase()) ||
            option.text.toLowerCase().includes(termo.toLowerCase())
        )) {
            encontrados.push(option);
        }
    }
    
    // Mostrar resultados
    if (encontrados.length > 0) {
        resultados.innerHTML = '';
        encontrados.forEach(opt => {
            const item = document.createElement('a');
            item.href = '#';
            item.className = 'list-group-item list-group-item-action';
            item.innerHTML = opt.text;
            item.onclick = (e) => {
                e.preventDefault();
                select.value = opt.value;
                carregarInfoItem();
                resultados.style.display = 'none';
                document.getElementById('busca_item').value = '';
            };
            resultados.appendChild(item);
        });
        resultados.style.display = 'block';
    } else {
        resultados.innerHTML = '<div class="list-group-item">Nenhum item encontrado</div>';
        resultados.style.display = 'block';
    }
}

// Buscar ao digitar Enter
document.getElementById('busca_item').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        buscarItem();
    }
});

function carregarInfoItem() {
    const select = document.getElementById('item_id');
    const option = select.options[select.selectedIndex];
    
    if (option.value) {
        const estoqueAtual = parseFloat(option.dataset.estoque);
        const unidade = option.dataset.unidade;
        
        document.getElementById('unidadeMedida').textContent = 'Unidade: ' + unidade;
        document.getElementById('estoqueAtual').textContent = estoqueAtual + ' ' + unidade;
        document.getElementById('infoEstoque').style.display = 'block';
        
        // Atualizar novo estoque quando quantidade mudar
        document.getElementById('quantidade').addEventListener('input', function() {
            const qtd = parseFloat(this.value) || 0;
            const novoEstoque = estoqueAtual + qtd;
            document.getElementById('novoEstoque').textContent = novoEstoque.toFixed(2) + ' ' + unidade;
        });
    } else {
        document.getElementById('infoEstoque').style.display = 'none';
        document.getElementById('unidadeMedida').textContent = '';
    }
}
</script>
{% endblock %}
